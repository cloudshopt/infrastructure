map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}

upstream frontend_upstream { server frontend:5173; }

server {
  listen 80;
  server_name app.localhost;

  client_max_body_size 50m;

  # ----------------------------
  # USERS: /api/users/* -> /api/*
  location = /api/users { return 308 /api/users/; }
  location ^~ /api/users/ {
    root /srv/user-service/public;

    rewrite ^/api/users/(.*)$ /api/$1 break;
    try_files $uri $uri/ @users;
  }
  location @users {
    root /srv/user-service/public;
    include fastcgi_params;

    fastcgi_param SCRIPT_FILENAME $document_root/index.php;
    fastcgi_param DOCUMENT_ROOT   $document_root;

    # KLJUČNO: Laravel naj vidi rewritan URI (/api/...)
    fastcgi_param REQUEST_URI $uri$is_args$args;

    # auth header (če uporabljaš Sanctum/JWT/Passport)
    fastcgi_param HTTP_AUTHORIZATION $http_authorization;

    # (opcijsko) če kdaj rabiš original prefix
    fastcgi_param HTTP_X_FORWARDED_PREFIX /api/users;

    fastcgi_pass php_users:9000;
  }

  # ----------------------------
  # PRODUCTS: /api/products/* -> /api/*
  location = /api/products { return 308 /api/products/; }
  location ^~ /api/products/ {
    root /srv/product-service/public;

    rewrite ^/api/products/(.*)$ /api/$1 break;
    try_files $uri $uri/ @products;
  }
  location @products {
    root /srv/product-service/public;
    include fastcgi_params;

    fastcgi_param SCRIPT_FILENAME $document_root/index.php;
    fastcgi_param DOCUMENT_ROOT   $document_root;
    fastcgi_param REQUEST_URI     $uri$is_args$args;
    fastcgi_param HTTP_AUTHORIZATION $http_authorization;
    fastcgi_param HTTP_X_FORWARDED_PREFIX /api/products;

    fastcgi_pass php_products:9000;
  }

  # ----------------------------
  # ORDERS: /api/orders/* -> /api/*
  location = /api/orders { return 308 /api/orders/; }
  location ^~ /api/orders/ {
    root /srv/order-service/public;

    rewrite ^/api/orders/(.*)$ /api/$1 break;
    try_files $uri $uri/ @orders;
  }
  location @orders {
    root /srv/order-service/public;
    include fastcgi_params;

    fastcgi_param SCRIPT_FILENAME $document_root/index.php;
    fastcgi_param DOCUMENT_ROOT   $document_root;
    fastcgi_param REQUEST_URI     $uri$is_args$args;
    fastcgi_param HTTP_AUTHORIZATION $http_authorization;
    fastcgi_param HTTP_X_FORWARDED_PREFIX /api/orders;

    fastcgi_pass php_orders:9000;
  }

  # ----------------------------
  # PAYMENTS: /api/payments/* -> /api/*
  location = /api/payments { return 308 /api/payments/; }
  location ^~ /api/payments/ {
    root /srv/payment-service/public;

    rewrite ^/api/payments/(.*)$ /api/$1 break;
    try_files $uri $uri/ @payments;
  }
  location @payments {
    root /srv/payment-service/public;
    include fastcgi_params;

    fastcgi_param SCRIPT_FILENAME $document_root/index.php;
    fastcgi_param DOCUMENT_ROOT   $document_root;
    fastcgi_param REQUEST_URI     $uri$is_args$args;
    fastcgi_param HTTP_AUTHORIZATION $http_authorization;
    fastcgi_param HTTP_X_FORWARDED_PREFIX /api/payments;

    fastcgi_pass php_payments:9000;
  }

  # če nekdo zadane /api/* brez service prefiksa, naj ne gre na frontend
  location ^~ /api/ {
    return 404;
  }

  # ----------------------------
  # FRONTEND (Vite dev server) - vse ostalo
  location / {
    proxy_pass http://frontend_upstream;
    proxy_http_version 1.1;

    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # HMR websockets
    proxy_set_header Upgrade           $http_upgrade;
    proxy_set_header Connection        $connection_upgrade;

    proxy_buffering off;
  }
}