# /etc/nginx/conf.d/default.conf

upstream frontend { server frontend:5173; }

server {
  listen 80 default_server;
  listen [::]:80 default_server;
  server_name _;

  client_max_body_size 20m;
  charset utf-8;

  # -------------------------
  # USERS API
  # outside: /api/users/...
  # inside:  /api/...
  # -------------------------
  location = /api/users { return 308 /api/users/; }

  location ^~ /api/users/ {
    # /api/users/info -> /api/info
    rewrite ^/api/users(/.*)$ /api$1 break;

    include fastcgi_params;

    fastcgi_param SCRIPT_FILENAME /srv/user-service/public/index.php;
    fastcgi_param DOCUMENT_ROOT  /srv/user-service/public;
    fastcgi_param SCRIPT_NAME    /index.php;

    # Laravel naj vidi pravilen (prepisan) path + query
    fastcgi_param REQUEST_URI $uri$is_args$args;

    fastcgi_pass php_users:9000;
  }

  # -------------------------
  # PRODUCTS API
  # outside: /api/products/...
  # inside:  /api/...
  # -------------------------
  location = /api/products { return 308 /api/products/; }

  location ^~ /api/products/ {
    # /api/products/info     -> /api/info
    # /api/products/products -> /api/products
    rewrite ^/api/products(/.*)$ /api$1 break;

    include fastcgi_params;

    fastcgi_param SCRIPT_FILENAME /srv/product-service/public/index.php;
    fastcgi_param DOCUMENT_ROOT  /srv/product-service/public;
    fastcgi_param SCRIPT_NAME    /index.php;

    fastcgi_param REQUEST_URI $uri$is_args$args;

    fastcgi_pass php_products:9000;
  }

  # -------------------------
  # ORDERS API
  # outside: /api/orders/...
  # inside:  /api/...
  # -------------------------
  location = /api/orders { return 308 /api/orders/; }

  location ^~ /api/orders/ {
    # /api/orders/info     -> /api/info
    # /api/orders/orders -> /api/orders
    rewrite ^/api/orders(/.*)$ /api$1 break;

    include fastcgi_params;

    fastcgi_param SCRIPT_FILENAME /srv/order-service/public/index.php;
    fastcgi_param DOCUMENT_ROOT  /srv/order-service/public;
    fastcgi_param SCRIPT_NAME    /index.php;

    fastcgi_param REQUEST_URI $uri$is_args$args;

    fastcgi_pass php_orders:9000;
  }

  # -------------------------
  # PAYMENTS API
  # outside: /api/payments/...
  # inside:  /api/...
  # -------------------------
  location = /api/payments { return 308 /api/payments/; }

  location ^~ /api/payments/ {
    # /api/payments/info     -> /api/info
    # /api/payments/payments -> /api/payments
    rewrite ^/api/payments(/.*)$ /api$1 break;

    include fastcgi_params;

    fastcgi_param SCRIPT_FILENAME /srv/payment-service/public/index.php;
    fastcgi_param DOCUMENT_ROOT  /srv/payment-service/public;
    fastcgi_param SCRIPT_NAME    /index.php;

    fastcgi_param REQUEST_URI $uri$is_args$args;

    fastcgi_pass php_payments:9000;
  }

  # -------------------------
  # FRONTEND (Vue/Vite dev)
  # -------------------------
  location / {
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    # Vite HMR websocket
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    proxy_pass http://frontend;
  }

  # (optional) quiet common noise
  location = /favicon.ico { access_log off; log_not_found off; }
  location = /robots.txt  { access_log off; log_not_found off; }
}